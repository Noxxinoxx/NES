<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MongoDB Log Viewer</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-800">
  <header class="bg-gray-800 text-white p-4">
    <h1 class="text-2xl font-bold">MongoDB Log Viewer</h1>
  </header>

  <main class="p-6 space-y-6">
    <!-- Entries Counter -->
    <div class="flex items-center justify-between bg-white p-4 rounded shadow">
      <h2 class="text-lg font-semibold text-gray-700">
        Entries: <span id="entryCount" class="text-gray-900 font-bold">0</span>
      </h2>
    </div>
    <!-- Filter dropdowns -->

    <div id="filterContainer" class="flex flex-wrap gap-3 items-end">
      <!-- Dynamic filters go here -->
    </div>

    <!-- Sort Order Button -->
    <div>
      <button id="toggleSort" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700">
        Show Oldest First
      </button>
    </div>
    <!-- Scrollable list -->
    <div id="entries" class="space-y-4 max-h-[70vh] overflow-y-auto p-2 border rounded bg-white">
      <!-- JS will render cards here -->
    </div>
    
  
  
  </main>

  <!-- Modal -->
  <div id="jsonModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center">
    <div class="bg-white rounded-lg w-11/12 md:w-3/4 lg:w-1/2 max-h-[80vh] flex flex-col">
      <div class="flex justify-between items-center p-4 border-b">
        <h3 class="text-lg font-semibold">Raw JSON</h3>
        <button id="closeModal" class="text-gray-500 hover:text-black text-xl">&times;</button>
      </div>
      <div class="overflow-y-auto p-4 text-sm bg-gray-50 flex-1">
        <pre id="modalContent" class="whitespace-pre-wrap"></pre>
      </div>
    </div>
  </div>

  <script>
    let mongoEntries = [];
    let filters = {};
    let activeFilters = {};
    let sortOrder = 'desc'; // newest first by default

    const filterContainer = document.getElementById('filterContainer');
    const entriesContainer = document.getElementById('entries');
    const modal = document.getElementById('jsonModal');
    const modalContent = document.getElementById('modalContent');
    const closeModal = document.getElementById('closeModal');
    const toggleSortBtn = document.getElementById('toggleSort');

    // --- Render entries ---
    function renderEntries(data) {
      entriesContainer.innerHTML = '';
      data.forEach(entry => {
        const card = document.createElement('div');
        card.className = 'border rounded p-4 hover:bg-gray-50 cursor-pointer';
        card.innerHTML = `
          <p class="font-mono text-sm text-gray-600">_id: ${entry._id}</p>
          <p>
            <span class="font-semibold">Category:</span> ${entry.category} |
            <span class="font-semibold">Level:</span> ${entry.level} |
            <span class="font-semibold">Event:</span> ${entry.event} |
            <span class="font-semibold">Source:</span> ${entry.source} |
            <span class="font-semibold">Time:</span> ${entry.time_stamp}
          </p>
        `;
        card.addEventListener('click', () => {
          modalContent.textContent = JSON.stringify(entry, null, 2);
          modal.classList.remove('hidden');
          modal.classList.add('flex');
        });
        entriesContainer.appendChild(card);
      });
    }

    // --- Modal close ---
    closeModal.addEventListener('click', () => {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    });

    // --- Apply filters & sort locally ---
    function applyFilters() {
      let filtered = mongoEntries.filter(entry => {
        return Object.keys(activeFilters).every(fName => {
          const val = activeFilters[fName];
          if (!val || val === 'all') return true;
          return String(entry[fName]).toLowerCase() === String(val).toLowerCase();
        });
      });

      // Sort by time_stamp
      filtered.sort((a, b) => {
        const dateA = new Date(a.time_stamp);
        const dateB = new Date(b.time_stamp);
        return sortOrder === 'asc' ? dateA - dateB : dateB - dateA;
      });

      renderEntries(filtered);
    }

    // --- Build dropdowns dynamically ---
    function buildFilterDropdowns() {
      filterContainer.innerHTML = '';
      Object.entries(filters).forEach(([name, values]) => {
        const select = document.createElement('select');
        select.className = 'px-3 py-2 border rounded';
        select.innerHTML = `<option value="all">All ${name}</option>` + 
          values.map(v => `<option value="${v}">${v}</option>`).join('');
        select.addEventListener('change', (e) => {
          activeFilters[name] = e.target.value;
          fetchEvents(); // refetch with server filters applied
        });
        filterContainer.appendChild(select);
      });
    }

    // --- Fetch filters from /api/filters ---
    async function fetchFilters() {
      try {
        const res = await fetch('/api/getFilters');
        if (!res.ok) throw new Error('Failed to fetch filters');
        filters = await res.json();
        buildFilterDropdowns();
        Object.keys(filters).forEach(k => activeFilters[k] = 'all');
      } catch (err) {
        console.error(err);
      }
    }

    // --- Fetch events with filters ---
    async function fetchEvents() {
      // Build query params
      const params = new URLSearchParams();
      Object.keys(activeFilters).forEach(k => {
        if (activeFilters[k] && activeFilters[k] !== 'all') {
          params.append(k, activeFilters[k]);
        }
      });

      try {
        const res = await fetch('/api/events?' + params.toString());
        if (!res.ok) throw new Error('Failed to fetch events');
        mongoEntries = await res.json();
        document.getElementById("entryCount").innerText = mongoEntries.length
        applyFilters();
      } catch (err) {
        console.error(err);
      }
    }

    // --- Toggle sort order ---
    toggleSortBtn.addEventListener('click', () => {
      sortOrder = (sortOrder === 'desc') ? 'asc' : 'desc';
      toggleSortBtn.textContent = (sortOrder === 'desc') ? 'Show Oldest First' : 'Show Newest First';
      applyFilters();
    });

    // --- Initial fetch ---
    fetchFilters().then(fetchEvents);

    // Optional auto refresh
    setInterval(fetchEvents, 30000);
  </script>
</body>
</html>
